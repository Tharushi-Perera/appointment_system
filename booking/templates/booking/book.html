{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}
{% block content %}
<style>
    .booking-container {
        display: flex;
        background: #fff;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        overflow: hidden;
        max-width: 900px;
        margin: 2rem auto;
    }
    .booking-left {
        flex: 1;
        background-image: url("{% static 'img/booking_banner.jpg' %}");
        background-size: cover;
        background-position: center;
    }
    .booking-right {
        flex: 1;
        padding: 3rem 2rem;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    .booking-right h2 {
        color: #1a1a3d;
        font-size: 2rem;
        font-weight: 700;
        text-align: center;
    }
    .booking-right p {
        text-align: center;
        margin-bottom: 2rem;
        color: #555;
    }
    .form-group {
        width: 100%;
        margin-bottom: 1rem;
    }
    .form-control {
        border-radius: 8px;
        padding: 0.6rem 1rem;
        border: 1px solid #ccc;
        width: 100%;
    }
    .btn-book {
        background-color: #5f2c82;
        color: #fff;
        font-weight: bold;
        border: none;
        padding: 0.6rem 2rem;
        border-radius: 10px;
        width: 100%;
        transition: 0.3s ease;
    }
    .btn-book:hover {
        background-color: #4c2370;
    }
    .booking-quote {
        font-style: italic;
        color: #666;
        margin-top: 1rem;
    }

    @media (max-width: 768px) {
        .booking-container {
            flex-direction: column;
        }
        .booking-left {
            height: 250px;
        }
        .loading {
    opacity: 0.7;
    pointer-events: none;
}
.loading-spinner {
    margin-left: 10px;
    animation: spin 1s linear infinite;
}
@keyframes spin {
    100% { transform: rotate(360deg); }
}
    }
</style>

<div class="booking-container">
    <div class="booking-left"></div>

    <div class="booking-right">
        <div class="text-center mb-3">
            <div style="font-size: 2rem;">ðŸ“…</div>
            <h2>Book Your Appointment</h2>
            <p>Choose your service and preferred date<br>to glam up!</p>
        </div>

        <form method="post" style="width: 100%; max-width: 400px;" id="appointment-form">
            {% csrf_token %}

            <div class="form-group">
                {{ form.category.label_tag }}
                {{ form.category|add_class:"form-control" }}
            </div>

            <div class="form-group">
                {{ form.subcategory.label_tag }}
                {{ form.subcategory|add_class:"form-control" }}
            </div>

            <div class="form-group">
                {{ form.service.label_tag }}
                {{ form.service|add_class:"form-control" }}
            </div>

            <div class="form-group">
                {{ form.date.label_tag }}
                {{ form.date|add_class:"form-control" }}
            </div>

            <button type="submit" class="btn-book">Next</button>
        </form>

        <div class="booking-quote text-center mt-3">
            "Be on time and let the glam begin!"
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    // Category change handler
    $('#id_category').change(function() {
        var categoryId = $(this).val();
        var $subcategory = $('#id_subcategory');
        var $service = $('#id_service');

        $subcategory.empty().append('<option value="">Select a subcategory</option>');
        $service.empty().append('<option value="">Select a service</option>');

        if (categoryId) {
            showLoading($subcategory);
            $.ajax({
                url: '{% url "booking:get_subcategories" %}',
                data: { 'category_id': categoryId },
                dataType: 'json',
                success: function(data) {
                    if(data.subcategories && data.subcategories.length > 0) {
                        $.each(data.subcategories, function(key, value) {
                            $subcategory.append($('<option>', {
                                value: value.id,
                                text: value.name
                            }));
                        });
                    } else {
                        $subcategory.append('<option value="">No subcategories found</option>');
                    }
                },
                error: function() {
                    $subcategory.append('<option value="">Error loading subcategories</option>');
                },
                complete: function() {
                    hideLoading($subcategory);
                }
            });
        }
    });

    // Subcategory change handler
    $('#id_subcategory').change(function() {
        var subcategoryId = $(this).val();
        var $service = $('#id_service');

        $service.empty().append('<option value="">Select a service</option>');

        if (subcategoryId) {
            showLoading($service);
            $.ajax({
                url: '{% url "booking:get_services" %}',
                data: { 'subcategory_id': subcategoryId },
                dataType: 'json',
                success: function(data) {
                    if(data.services && data.services.length > 0) {
                        $.each(data.services, function(key, value) {
                            $service.append($('<option>', {
                                value: value.id,
                                text: value.name + ' - Rs. ' + value.price + ' (' + value.duration_minutes + ' mins)'
                            }));
                        });
                    } else {
                        $service.append('<option value="">No services found</option>');
                    }
                },
                error: function() {
                    $service.append('<option value="">Error loading services</option>');
                },
                complete: function() {
                    hideLoading($service);
                }
            });
        }
    });

    function showLoading(element) {
        element.prop('disabled', true);
        element.addClass('loading');
        element.after('<span class="loading-spinner">âŒ›</span>');
    }

    function hideLoading(element) {
        element.prop('disabled', false);
        element.removeClass('loading');
        element.next('.loading-spinner').remove();
    }
});
</script>
{% endblock %}
